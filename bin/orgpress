#!/usr/bin/env ruby
require 'pathname'
require 'yaml'

ORGPRESS_ROOT     = (Pathname(__FILE__).dirname + "..")
ORGPRESS_BIN      = (ORGPRESS_ROOT + "bin").expand_path
ORGPRESS_MAKEFILE = ORGPRESS_ROOT + "main.mk"
CALC_VPATH        = (ORGPRESS_BIN + "calc_vpath")
BOOK_SPEC         = Pathname("book.yml").expand_path
BOOK_DIR          = BOOK_SPEC.dirname
BOOK_DIRNAME      = BOOK_DIR.basename.to_s
STAGES            = %w[
  normalize concatenate extract prepare-objects expand finished
]

path = "#{ORGPRESS_BIN}#{File::PATH_SEPARATOR}#{ENV['PATH']}"

env = {
  "OP_BOOK_NAME" => BOOK_DIRNAME,
  "OP_STAGES"    => STAGES.join(" "),
  "PATH"         => path
}


if BOOK_SPEC.exist?
  YAML.load_file(BOOK_SPEC).each do |key, value|
    env["OP_#{key.upcase}"] = Array(value).join(" ")
  end
end

case ARGV.first
when "which"
  exec(env, CALC_VPATH.to_s, *ARGV)
else
  make_args = %W(-f #{ORGPRESS_MAKEFILE}) + ARGV
  exec(env, "make", *make_args)
end
